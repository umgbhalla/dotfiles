/*Copyright (c) 2021 ksoft http://www.dummysoftware.com*/var sAKXQ=new Array,BYCpe=[],bOdzk=[],canvas=document.createElement("canvas"),context=canvas.getContext("2d"),KnCOZ=new Image,audio=null,yzGgC={on:"images/refresh-on-38.png",off:"images/refresh-off-38.png",restart:"images/refresh-restart-38.png"};function onInitialize(){chrome.tabs.getAllInWindow(null,function(e){lXjtD(e)});chrome.tabs.onUpdated.addListener(function(e,t,n){RbZMJ(n)}),chrome.tabs.onRemoved.addListener(function(e,t){oPNzR(e)}),chrome.extension.onRequest.addListener(function(e,t,n){onRequest(e)}),chrome.runtime.onMessage.addListener(function(e,t,n){onMessage(e)}),chrome.runtime.onInstalled.addListener(function(e){ONiHv(e)}),chrome.notifications.onClicked.addListener(function(e){zJBlp(e)}),canvas.width=19,canvas.height=19,KnCOZ.src=yzGgC.on}function ONiHv(e){var t=chrome.runtime.getManifest().version;"install"==e.reason?chrome.tabs.create({url:"http://www.dummysoftware.com/easy-auto-refresh/?action=install&new="+t}):"update"==e.reason&&0<e.previousVersion&&e.previousVersion<6&&chrome.tabs.create({url:"http://www.dummysoftware.com/easy-auto-refresh/?action=update&old="+e.previousVersion+"&new="+t})}function lXjtD(e){for(var t,n=0;t=e[n];n++)QKphw(t.url)||isvJT(t)}function RbZMJ(e){QKphw(e.url)||(isvJT(e),KoAxF(e))}function oPNzR(e){wFkIX({id:e},!1)}function isvJT(e){1==getOptions(e).refresh?(chrome.pageAction.setIcon({path:yzGgC.on,tabId:e.id}),onRequest({tab:e,refresh:!0})):(chrome.pageAction.setIcon({path:yzGgC.off,tabId:e.id}),wFkIX(e,!0)),chrome.pageAction.show(e.id)}function QKphw(e){return-1<e.indexOf("chrome:")}function akUjC(e){for(var t=0;t<sAKXQ.length;t++){var n=sAKXQ[t];if(n.tab.id==e.id)return n}return null}function VOhPV(e){for(var t=0;t<sAKXQ.length;t++)if(sAKXQ[t]==e)return void sAKXQ.splice(t,1)}function wFkIX(e,t){var n=akUjC(e);null!=n&&(clearInterval(n.intervalId),clearInterval(n.timerIntervalId),VOhPV(n),delete bOdzk["tab"+e.id],t&&(chrome.pageAction.setIcon({path:yzGgC.off,tabId:e.id}),chrome.pageAction.show(e.id),chrome.pageAction.setTitle({tabId:e.id,title:"Easy Auto Refresh"})),null!=e.url&&(-1==e.url.indexOf("chrome.google.com")&&-1==e.url.indexOf("file://")&&chrome.tabs.executeScript(e.id,{code:"keyPressManager.remove();"}),(t=getOptions(e)).lastRefresh=null,t.nextRefresh=null,saveOptions(e,t)))}function GHUwC(e,t,n){var i=akUjC(e);return null!=i&&i.intervalValue==t&&(n.isDomain?getDomain(i.tab.url)==getDomain(e.url):i.tab.url==e.url)}function FROCm(t,e){var n,i=new Date,a=new Date(BYCpe["tab"+t.id]),o=Math.round((i-a)/1e3);(isNaN(o)||1<o)&&((n=1==e.isAutoClick&&null!=e.autoClickId&&0<e.autoClickId.length&&"1"==e.autoClickIdValid)&&!e.isAutoClickAfterRefresh?(LXfPm(t,e.autoClickId,e.autoClickDelay,e.isAutoClickAfterRefresh),BYCpe["tab"+t.id]=i):1==e.isUrlList&&e.urlList&&0<e.urlList.length?(a=0,(o=e.urlListLast)&&(-1<(a=e.urlList.indexOf(o))?a++:a=0,a>=e.urlList.length&&(a=0)),(i=e.urlList[a])&&((a=(o=e.urlListLast=i).split("/"))&&a.length<=3&&(o+="/"),saveOptions({url:o},e),chrome.tabs.update(t.id,{url:i},function(e){AZxII(e)}))):-1==t.url.indexOf("chrome.google.com")&&-1==t.url.indexOf("file://")?chrome.tabs.executeScript(t.id,{code:"location.reload(true);"},function(e){AZxII(e,function(e){e&&chrome.tabs.update(t.id,{url:t.url})})}):chrome.tabs.update(t.id,{url:t.url}),n&&e.isAutoClickAfterRefresh&&((n=akUjC(t))&&(n.autoClickId=e.autoClickId)))}function refresh(e,n){n.isAllTabs?chrome.tabs.query({windowId:e.windowId},function(e){for(var t in e)FROCm(e[t],n)}):FROCm(e,n)}function XHRRs(e){var t=getOptions(e),n=1==t.isRandom?(t=JmzVO(e)).random:(gqXkt(t)?t=lyfgK(e):t).interval;1==t.isCache&&chrome.browsingData.removeCache({since:0}),refresh(e,t),t=updateLastRefresh(t,n),saveOptions(e,t),chrome.runtime.sendMessage({message:"updateLastRefresh",lastRefresh:t.lastRefresh,nextRefresh:t.nextRefresh,tabId:e.id})}function onRequest(e){var t,n;1==e.refresh?(n=1e3*(t=getOptions(e.tab)).interval,gqXkt(t)?n=1e3*(t=lyfgK(e.tab)).interval:null!=t.random&&(n=1e3*t.random),GHUwC(e.tab,n,t)&&!e.force||(wFkIX(e.tab,!1),intervalId=setInterval(function(){XHRRs(e.tab,t.random)},n),timerIntervalId=setInterval(function(){uBjxm(e.tab)},1e3),sAKXQ.push({tab:e.tab,intervalId:intervalId,timerIntervalId:timerIntervalId,intervalValue:n}),t=updateLastRefresh(t,n/1e3),saveOptions(e.tab,t)),-1==e.tab.url.indexOf("chrome.google.com")&&-1==e.tab.url.indexOf("file://")&&chrome.tabs.executeScript(e.tab.id,{code:"keyPressManager.setup("+e.tab.id+");"}),n=gqXkt(t)?t.nextRefresh:n/1e3+" seconds",chrome.pageAction.setIcon({path:yzGgC.on,tabId:e.tab.id}),chrome.pageAction.show(e.tab.id),chrome.pageAction.setTitle({tabId:e.tab.id,title:"Easy Auto Refresh ON : "+n})):wFkIX(e.tab,!0)}function onMessage(n){"resetInterval"==n.action?chrome.tabs.get(n.tabId,function(n){onRequest({tab:n,refresh:!0,force:!0}),chrome.pageAction.setIcon({path:yzGgC.restart,tabId:n.id}),chrome.pageAction.show(n.id),setTimeout(function(){var t=n;chrome.tabs.get(t.id,function(e){t.url==e.url&&(chrome.pageAction.setIcon({path:yzGgC.on,tabId:n.id}),chrome.pageAction.show(n.id))})},1e3)}):"getPath"==n.message&&chrome.tabs.query({active:!0},function(e){var t=e[0],e=getOptions(t);e.autoClickId=n.value,e.autoClickIdValid=1,saveOptions(t,e),alert("Web page element successfully selected.\n\n"+n.string)})}function JmzVO(e){var t=getOptions(e),n=t.interval,n=parseInt(n,10);n<=5&&(n=60);n=getRandomInt(5,n);return t.random=n,saveOptions(e,t),chrome.runtime.sendMessage({message:"updateRandomInterval",value:n,tabId:e.id}),onRequest({tab:e,refresh:!0}),t}function gqXkt(e){var t=!1;return t=e?1==e.isTimeList&&e.timeList&&e.timeList.length:t}function lyfgK(e){for(var t=getOptions(e),n=t.interval,i=[],a=-1,o=-1,s=new Date,r=0;r<t.timeList.length;r++){var c,l=t.timeList[r],d=l.match(/^(\d{1,2}):(\d{2})$/);d&&2<=d.length&&(c=d[1],d=d[2],d=60*parseInt(c)*60+parseInt(60*d)-(60*s.getHours()*60+60*s.getMinutes()+s.getSeconds()),i.push({time:l,seconds:d}),0<d&&(-1===a||d<i[a].seconds)?a=i.length-1:(-1===o||d<i[o].seconds)&&(o=i.length-1))}return-1<a?n=i[a].seconds:-1<o&&(n=86400+(n=i[o].seconds)),t.interval=n,saveOptions(e,t),chrome.runtime.sendMessage({message:"updateTimeInterval",value:n,tabId:e.id}),t}function uBjxm(e){var t=getOptions(e),n=new Date,i=Date.parse(t.nextRefresh),a=t.isTimer?1e4:10;isNaN(i)||(i=new Date(i),-1<(n=Math.round((i-n)/1e3))&&n<a?chrome.pageAction.setIcon({imageData:PHWSQ(n,99<n?"8px Tahoma":"10px Courier New"),tabId:e.id}):gqXkt(t)||chrome.pageAction.setIcon({path:yzGgC.on,tabId:e.id}))}function PHWSQ(e,t){var n=9,i=8,a=1;return t=t||"10px Courier New",2<=e.toString().length&&(n-=7,i+=7),4<=e.toString().length&&(i+=1,a=0),context.clearRect(0,0,canvas.width,canvas.height),context.drawImage(KnCOZ,0,0,canvas.width,canvas.height),context.fillStyle="#ffffff",context.fillRect(n,8,i,10),context.strokeStyle="#ff0000",context.strokeRect(n,8,i,10),context.fillStyle="black",context.font=t,context.fillText(e,n+a,16),context.getImageData(0,0,canvas.width,canvas.height)}function BdlaI(t,n,i,a){var o=new Date,e=new Date(bOdzk["tab"+t.id]),e=Math.round((o-e)/1e3);(isNaN(e)||3<e)&&chrome.tabs.executeScript(t.id,{file:"scripts/content.js"},function(e){chrome.tabs.sendMessage(t.id,{action:"findText"+n,isText:i},function(e){void 0!==e&&(!a&&1==e.result||a&&!e.result)&&(e=getOptions(t),bOdzk["tab"+t.id]=o,chrome.notifications.create("notification-"+t.windowId+"-"+t.id,{type:"basic",title:"Easy Auto Refresh",message:`The keyword "${n.trim()}" was ${a?"NOT":""} found in Tab ${t.index+1}. ${e.isNotifyStop?"\nRefresh has stopped.":""}`,contextMessage:t.url,eventTime:o.getTime(),iconUrl:"images/notification.png"}),e.notifySound&&(!audio||audio.src&&!audio.src.endsWith(e.notifySound))&&((audio=new Audio).src=e.notifySound),audio.play(),e.isNotifyStop&&wFkIX(t,!0))})})}function KoAxF(e){var t,n,i,a=getOptions(e);1==a.refresh&&a.isNotify&&a.notifyText&&(t=!1,i=a.notifyDelay,0<(n=a.notifyText).toUpperCase().indexOf("[TEXT]")&&(t=!0,n=n.replace(/\[TEXT\]/i,"")),matches=n.match(/(.*)\[(\d+)\]/),matches&&3<=matches.length&&(i=parseInt(matches[2]))&&(i<0?i=0:9<i&&(i=9),n=matches[1]),i?setTimeout(function(){BdlaI(e,n,t,a.isNotifyNotFound)},1e3*i):BdlaI(e,n,t,a.isNotifyNotFound)),!a.isAutoClickAfterRefresh||(i=akUjC(e))&&i.autoClickId&&(delete i.autoClickId,LXfPm(e,a.autoClickId,a.autoClickDelay,a.isAutoClickAfterRefresh))}function LXfPm(e,t,n,i){var a="";n=i?n||0:0,a=0==t.indexOf("document.")?"var link = null; try { link = "+t.replace(/"/g,"'")+" } catch(e) {} if (link != null) { link.click(); }":"var link = null; try { link = document.querySelector('"+t.replace(/'/g,"\\'").replace(/"/g,'\\"')+"'); } catch(e) {} if (link != null) { link.click(); }",setTimeout(function(){chrome.tabs.executeScript(e.id,{code:a},function(){KoAxF(e)})},1e3*n)}function zJBlp(e){var t,n=e.match(/notification-(\d+)-(\d+)/);null!=n&&3==n.length&&(t=parseInt(n[1]),n=parseInt(n[2]),chrome.windows.update(t,{focused:!0}),chrome.tabs.update(n,{highlighted:!0}),chrome.notifications.clear(e))}function AZxII(e,t){if(void 0===e){var n=chrome.extension.lastError;if(n&&n.message)if(-1!=n.message.indexOf("No tab with id")){e=n.message.match(/\d+/);e&&1==e.length&&wFkIX({id:e[0]})}else if(-1!=n.message.indexOf("Cannot access contents of the page"))return void(t&&t(!0))}t&&t()}